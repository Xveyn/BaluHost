name: Playwright E2E

# Notes:
# - To allow live E2E runs, add a repository secret named `RUN_LIVE_E2E` and set it to `true` only
#   when you want to enable live, production-adjacent tests. Keep this secret off for normal PRs.
# - Protect the `live-e2e` environment (Repository Settings → Environments) and require
#   reviews/approvals before allowing jobs to run there — this provides an additional safety
#   gate beyond the secret.
# - The `live-e2e` job checks `secrets.RUN_LIVE_E2E` at runtime and will abort if it is not set
#   to `true`. Use manual `workflow_dispatch` to start the live job and ensure approvers are
#   available to review the protected environment.

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ '*' ]
  workflow_dispatch: {}

jobs:
  mock-e2e:
    name: Mocked E2E (fast)
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run == 'mock'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend deps (best-effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements-dev.txt ]; then python -m pip install -r backend/requirements-dev.txt; fi

      - name: Install client deps
        run: |
          cd client
          npm ci
          npx playwright install --with-deps

      - name: Start backend
        run: |
          nohup python start_dev.py &
          sleep 2

      - name: Start frontend dev server
        run: |
          cd client
          nohup npm run dev -- --host 0.0.0.0 --port 5173 &
          sleep 4

      - name: Wait for services
        run: |
          # Wait up to 60s for frontend and backend to be reachable (check http and https fallback)
          for i in {1..60}; do curl -sSf http://localhost:5173 && break || sleep 1; done
          for i in {1..60}; do curl -sSf https://localhost:5173 && break || true; sleep 1; done
          for i in {1..60}; do curl -sSf http://127.0.0.1:8000 && break || sleep 1; done

      - name: Run mocked Playwright tests
        run: |
          cd client
          # Ensure Playwright uses the explicit HTTP base url in CI
          PLAYWRIGHT_BASE_URL=http://localhost:5173 npx playwright test tests/e2e/schedulers.spec.ts --project=chromium --reporter=list

  live-e2e:
    name: Live E2E (gated)
    runs-on: ubuntu-latest
    needs: mock-e2e
    if: github.event_name == 'workflow_dispatch'
    environment: live-e2e
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend deps (best-effort)
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements-dev.txt ]; then python -m pip install -r backend/requirements-dev.txt; fi

      - name: Install client deps
        run: |
          cd client
          npm ci
          npx playwright install --with-deps

      - name: Start backend
        run: |
          nohup python start_dev.py &
          sleep 2

      - name: Start frontend dev server
        run: |
          cd client
          nohup npm run dev -- --host 0.0.0.0 --port 5173 &
          sleep 4

      - name: Verify RUN_LIVE_E2E secret is enabled
        run: |
          if [ "${{ secrets.RUN_LIVE_E2E }}" != "true" ]; then
            echo "RUN_LIVE_E2E secret is not 'true' - aborting live E2E run" >&2
            exit 78
          fi

      - name: Wait for services
        run: |
          for i in {1..30}; do curl -sSf http://localhost:5173 && break || sleep 1; done
          for i in {1..30}; do curl -sSf http://127.0.0.1:8000 || sleep 1 && break || true; done

      - name: Run live Playwright tests
        env:
          BASE_URL: https://localhost:5173
        run: |
          cd client
          npx playwright test tests/e2e/schedulers.live.spec.ts --project=chromium --reporter=list
