name: Create GitHub Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Extract release notes from CHANGELOG
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Extract section for this version (between ## [version] and next ---)
          notes=$(awk -v ver="$VERSION" '$0 ~ "^## \\[" ver "\\]" {found=1; next} /^---$/{if(found) exit} found' CHANGELOG.md)
          echo "$notes" > /tmp/release-notes.md

      - name: Determine pre-release
        id: prerelease
        env:
          TAG: ${{ github.ref_name }}
        run: |
          if [[ "$TAG" == *-alpha* ]] || [[ "$TAG" == *-beta* ]]; then
            echo "flag=--prerelease" >> "$GITHUB_OUTPUT"
          else
            echo "flag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
          PRERELEASE_FLAG: ${{ steps.prerelease.outputs.flag }}
        run: |
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file /tmp/release-notes.md \
            $PRERELEASE_FLAG
