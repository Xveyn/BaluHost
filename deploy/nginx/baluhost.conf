# ===================================
# BaluHost Nginx Reverse Proxy Configuration
# ===================================
# This configuration provides:
# - SSL/TLS termination with Let's Encrypt
# - HTTP to HTTPS redirect
# - Reverse proxy to backend API
# - Static file serving for frontend
# - WebSocket/SSE support
# - Security headers
# - Rate limiting
# - Gzip compression
#
# Place this file in: /etc/nginx/sites-available/baluhost.conf
# Enable with: ln -s /etc/nginx/sites-available/baluhost.conf /etc/nginx/sites-enabled/
# Test with: nginx -t
# Reload with: systemctl reload nginx
# ===================================

# Rate limiting zones
# Adjust rates based on your needs
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=10r/m;

# Upstream backend (Docker or systemd)
upstream baluhost_backend {
    # For Docker Compose deployment:
    server localhost:8000;

    # For systemd deployment, use Unix socket:
    # server unix:/run/baluhost/backend.sock;

    # Keep connections alive
    keepalive 32;
}

# ===================================
# HTTP Server (Redirect to HTTPS)
# ===================================
server {
    listen 80;
    listen [::]:80;
    server_name YOUR_DOMAIN_HERE;

    # Let's Encrypt ACME challenge
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ===================================
# HTTPS Server (Main Configuration)
# ===================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name YOUR_DOMAIN_HERE;

    # SSL Certificate (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN_HERE/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN_HERE/privkey.pem;

    # SSL Configuration (Best Practices)
    include /etc/nginx/snippets/ssl-params.conf;

    # Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    # Logging
    access_log /var/log/nginx/baluhost_access.log;
    error_log /var/log/nginx/baluhost_error.log warn;

    # Max upload size (adjust based on your needs)
    client_max_body_size 10G;
    client_body_timeout 600s;
    client_header_timeout 600s;

    # ===================================
    # Backend API Proxy
    # ===================================
    location /api/ {
        # Rate limiting for API endpoints
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        # Proxy to backend
        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;

        # WebSocket/SSE support (for upload progress, telemetry)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Forward headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeouts for long-running operations
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # Buffering (disable for SSE/WebSocket)
        proxy_buffering off;
        proxy_request_buffering off;

        # Keep-alive
        proxy_set_header Connection "";
    }

    # ===================================
    # Authentication Endpoints (Stricter Rate Limiting)
    # ===================================
    location ~ ^/api/auth/(login|register|refresh) {
        limit_req zone=auth_limit burst=3 nodelay;
        limit_req_status 429;

        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # ===================================
    # File Upload Endpoints (Dedicated Rate Limiting)
    # ===================================
    location ~ ^/api/files/upload {
        limit_req zone=upload_limit burst=5 nodelay;
        limit_req_status 429;

        # Larger timeouts for uploads
        proxy_connect_timeout 1800s;
        proxy_send_timeout 1800s;
        proxy_read_timeout 1800s;

        # Disable buffering for large uploads
        proxy_request_buffering off;
        proxy_buffering off;

        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # ===================================
    # Avatar Uploads
    # ===================================
    location /avatars/ {
        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache avatars
        proxy_cache_valid 200 1d;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # ===================================
    # Frontend (React SPA)
    # ===================================
    location / {
        # For Docker Compose: Proxy to frontend container
        proxy_pass http://localhost:80;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # For native deployment: Serve static files directly
        # root /var/www/baluhost/frontend;
        # try_files $uri $uri/ /index.html;

        # Cache control for SPA
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ===================================
    # Static Assets (if serving directly)
    # ===================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # For Docker: Proxy to frontend
        proxy_pass http://localhost:80;

        # For native: Serve directly
        # root /var/www/baluhost/frontend;
        # expires 1y;
        # add_header Cache-Control "public, immutable";
        # access_log off;
    }

    # ===================================
    # Health Check Endpoint (No Rate Limiting)
    # ===================================
    location /api/system/health {
        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # ===================================
    # API Documentation (Optional: Restrict to Internal IPs)
    # ===================================
    location /api/docs {
        # Uncomment to restrict access to internal network only
        # allow 10.0.0.0/8;
        # allow 172.16.0.0/12;
        # allow 192.168.0.0/16;
        # deny all;

        proxy_pass http://baluhost_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===================================
    # Security: Block Access to Sensitive Files
    # ===================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \.(env|git|gitignore|md|txt|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ===================================
    # Compression
    # ===================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/x-javascript
        application/xml+rss
        application/javascript
        application/json
        image/svg+xml;
    gzip_disable "msie6";
}
